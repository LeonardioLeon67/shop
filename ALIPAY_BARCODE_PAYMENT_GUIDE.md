# 支付宝付款码支付接入指南

## 概述

已为您的商城项目接入了支付宝付款码支付功能。付款码支付是指用户展示付款码，商家扫码收款的支付方式。

## 实现内容

### 1. 后端API实现

#### 付款码支付接口
- **路径**: `/api/payment/barcode`
- **方法**: POST
- **功能**: 处理用户付款码支付请求

**请求参数**:
```json
{
  "orderNo": "订单号",
  "authCode": "用户付款码（16-28位数字）",
  "paymentMethod": "alipay"
}
```

**响应结果**:
- 支付成功：返回交易信息
- 等待密码：返回等待状态，需要轮询查询
- 支付失败：返回错误信息

#### 支付状态查询接口
- **路径**: `/api/payment/barcode?orderNo=订单号`
- **方法**: GET
- **功能**: 查询付款码支付状态（用于等待用户输入密码的情况）

### 2. 前端页面实现

#### 付款码支付页面
- **路径**: `/payment/barcode/[orderId]`
- **功能**: 
  - 展示订单信息
  - 输入付款码
  - 处理支付流程
  - 自动查询支付结果

### 3. 支付宝服务扩展

在 `libs/alipay.ts` 中添加了 `barcodePay` 方法，实现了支付宝付款码支付（alipay.trade.pay）接口。

## 使用流程

### 商家操作流程：

1. **创建订单**
   - 用户在商城选择商品并创建订单

2. **选择付款码支付**
   - 在支付选项中选择"付款码支付"
   - 跳转到付款码支付页面

3. **输入付款码**
   - 让用户打开支付宝APP
   - 点击"付钱"功能展示付款码
   - 商家输入付款码数字（16-28位）

4. **确认支付**
   - 点击"确认支付"按钮
   - 系统调用支付宝API进行支付

5. **支付结果**
   - 小额免密支付：直接支付成功
   - 需要密码：页面提示等待用户输入密码，自动轮询查询结果
   - 支付失败：显示错误信息

## 配置要求

确保在 `.env` 文件中配置了以下支付宝参数：

```env
# 支付宝配置
ALIPAY_APP_ID=你的支付宝应用ID
ALIPAY_PRIVATE_KEY=你的应用私钥
ALIPAY_PUBLIC_KEY=支付宝公钥
ALIPAY_GATEWAY_URL=https://openapi.alipay.com/gateway.do
```

## 安全注意事项

1. **付款码验证**
   - 系统会验证付款码格式（16-28位数字）
   - 防止无效输入

2. **订单验证**
   - 支付前验证订单存在性和状态
   - 防止重复支付

3. **支付结果确认**
   - 支付成功后更新订单状态
   - 记录支付详情信息

## 测试建议

1. **沙箱环境测试**
   - 使用支付宝沙箱环境进行测试
   - 沙箱APP生成测试付款码

2. **生产环境**
   - 确保支付宝应用已上线
   - 配置正确的生产环境密钥

## 集成到现有支付流程

如需在订单页面添加付款码支付选项，可以在支付方式选择后添加跳转：

```javascript
// 在订单提交成功后
if (paymentMethod === 'barcode') {
  router.push(`/payment/barcode/${order._id}`);
} else {
  // 原有的二维码支付流程
}
```

## 问题排查

1. **配置问题**
   - 检查环境变量是否正确配置
   - 确认密钥格式正确（RSA2私钥需要包含头尾标记）

2. **支付失败**
   - 查看控制台日志了解具体错误
   - 检查付款码是否有效
   - 确认订单金额是否正确

3. **轮询超时**
   - 默认30秒超时，可根据需要调整
   - 提醒用户尽快输入密码

## 后续优化建议

1. **添加付款码扫码功能**
   - 集成摄像头扫码，避免手动输入
   - 提高用户体验

2. **支付方式整合**
   - 在订单页面统一展示所有支付方式
   - 包括二维码支付和付款码支付

3. **订单管理优化**
   - 添加付款码支付的订单标识
   - 方便商家区分不同支付方式的订单